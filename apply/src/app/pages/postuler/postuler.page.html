<ion-header>
  <app-user-header></app-user-header>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Postuler</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-item lines="full">
    <ion-label position="stacked">Coller l'offre d'emploi ici</ion-label>
    <ion-textarea
      rows="8"
      placeholder="Entrez ou collez la description compl√®te de l'offre d'emploi..."
      aria-label="Offre d'emploi"
      [(ngModel)]="jobOfferText"
      [disabled]="isExtractingText || isGeneratingAIContent || isSavingCandidature">
    </ion-textarea>
  </ion-item>

  <!-- Section CV -->
  <div class="ion-margin-top cv-selection-section">
    <ion-item lines="none">
      <ion-label>
        <h2>Choisir votre CV</h2>
      </ion-label>
    </ion-item>

    <!-- Spinner pendant le chargement du CV r√©cent -->
    <ion-item *ngIf="isLoadingRecentCv" lines="none">
      <ion-spinner name="crescent" slot="start"></ion-spinner>
      <ion-label>Chargement du CV le plus r√©cent...</ion-label>
    </ion-item>

    <!-- Radio group pour choisir entre CV r√©cent et upload -->
    <ion-radio-group [(ngModel)]="cvSelectionMode" [disabled]="isExtractingText || isGeneratingAIContent || isSavingCandidature">
      
      <!-- Option 1: CV le plus r√©cent -->
      <ion-item *ngIf="mostRecentCv && !isLoadingRecentCv" class="cv-info">
        <ion-radio slot="start" value="recent"></ion-radio>
        <ion-label>
          <h3>Utiliser le CV le plus r√©cent</h3>
          <p>{{ getCvDisplayName() }}</p>
          <p><small>Cr√©√© le {{ getCvCreationDate() }}</small></p>
        </ion-label>
        <ion-icon name="document-text-outline" slot="end" color="primary"></ion-icon>
      </ion-item>

      <!-- Option 2: Upload nouveau CV -->
      <ion-item class="cv-info">
        <ion-radio slot="start" value="upload"></ion-radio>
        <ion-label>
          <h3>Uploader un nouveau CV</h3>
          <p *ngIf="!mostRecentCv && !isLoadingRecentCv"><small>Aucun CV sauvegard√© trouv√©</small></p>
        </ion-label>
        <ion-button 
          slot="end" 
          fill="outline" 
          (click)="triggerFileInput()" 
          [disabled]="cvSelectionMode !== 'upload' || isExtractingText || isGeneratingAIContent || isSavingCandidature">
          <ion-icon slot="start" name="document-attach-outline"></ion-icon>
          Choisir fichier
        </ion-button>
      </ion-item>
    </ion-radio-group>

    <!-- Input file cach√© -->
    <input type="file" #fileInput hidden
           (change)="handleFileSelected($event)"
           accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.pdf,application/pdf" />

    <!-- Affichage du fichier s√©lectionn√© -->
    <ion-item *ngIf="selectedFileName && cvSelectionMode === 'upload' && !isExtractingText" lines="none" class="ion-margin-start">
      <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
      <ion-label color="medium">
        <small>{{ selectedFileName }}</small>
      </ion-label>
      <ion-button fill="clear" slot="end" (click)="clearFileSelection()" color="danger" 
                  [disabled]="isExtractingText || isGeneratingAIContent || isSavingCandidature">
        <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
      </ion-button>
    </ion-item>

    <!-- Extraction en cours -->
    <ion-item *ngIf="isExtractingText" lines="none" class="ion-margin-start">
      <ion-spinner name="crescent" slot="start"></ion-spinner>
      <ion-label>Traitement du CV en cours...</ion-label>
    </ion-item>

    <!-- Succ√®s extraction -->
    <ion-item *ngIf="!isExtractingText && ((cvSelectionMode === 'upload' && selectedFile && extractedCvText !== null) || (cvSelectionMode === 'recent' && mostRecentCv && mostRecentCvText))" 
              lines="none" class="ion-margin-start">
      <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
      <ion-label color="success">
        <small>
          CV pr√™t √† utiliser
          <span *ngIf="cvSelectionMode === 'upload'"> ({{ getFileTypeLabel(selectedFile) }}) extrait</span>
          <span *ngIf="cvSelectionMode === 'recent'"> (CV g√©n√©r√©)</span>
        </small>
      </ion-label>
    </ion-item>

    <!-- √âchec extraction -->
    <ion-item *ngIf="!isExtractingText && cvSelectionMode === 'upload' && selectedFile && extractedCvText === null && selectedFileName" 
              lines="none" class="ion-margin-start">
      <ion-icon name="warning" slot="start" color="danger"></ion-icon>
      <ion-label color="danger">
        <small>√âchec de l'extraction du texte du CV ({{ getFileTypeLabel(selectedFile) }}).</small>
      </ion-label>
    </ion-item>

    <!-- Info pour sauvegarder le CV upload√© -->
    <ion-item *ngIf="cvSelectionMode === 'upload' && extractedCvText && !isExtractingText" lines="none" class="ion-margin-start">
      <ion-label class="ion-margin-start">
        <p><small>üí° Pour sauvegarder un CV, utilisez la section "Mon CV Structur√©"</small></p>
      </ion-label>
    </ion-item>
  </div>

  <!-- Bouton g√©n√©rer -->
  <ion-button expand="block" class="ion-margin-top" (click)="generateApplication()" 
              [disabled]="!jobOfferText || !isCvReady() || isGeneratingAIContent || isExtractingText || isSavingCandidature">
    <ion-spinner *ngIf="isGeneratingAIContent" name="crescent" slot="start"></ion-spinner>
    <ion-icon *ngIf="!isGeneratingAIContent" slot="start" name="sparkles-outline"></ion-icon>
    {{ isGeneratingAIContent ? 'G√©n√©ration IA en cours...' : 'G√©n√©rer Analyse & Lettre' }}
  </ion-button>

  <!-- Erreur IA -->
  <div *ngIf="aiError" class="ion-padding ion-text-center" style="color: var(--ion-color-danger);">
    <p>{{ aiError }}</p>
  </div>

  <!-- R√©sultats ATS -->
  <div *ngIf="atsAnalysisResult && !isGeneratingAIContent && !isSavingCandidature" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Analyse ATS</ion-card-title>
        <p *ngIf="atsAnalysisResult.jobTitle"><strong>Poste :</strong> {{ atsAnalysisResult.jobTitle }}</p>
        <p *ngIf="atsAnalysisResult.company"><strong>Entreprise :</strong> {{ atsAnalysisResult.company }}</p>
      </ion-card-header>
      <ion-card-content>
        <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ atsAnalysisResult.analysisText }}</pre>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Lettre de motivation -->
  <div *ngIf="generatedCoverLetter && !isGeneratingAIContent && !isSavingCandidature" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Lettre de Motivation G√©n√©r√©e</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ generatedCoverLetter }}</pre>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Bouton sauvegarder candidature -->
  <ion-button expand="block" color="success" class="ion-margin-top"
              (click)="saveCandidature()"
              [disabled]="!atsAnalysisResult || !generatedCoverLetter || isSavingCandidature || isGeneratingAIContent || isExtractingText">
    <ion-spinner *ngIf="isSavingCandidature" name="crescent" slot="start"></ion-spinner>
    <ion-icon *ngIf="!isSavingCandidature" name="save-outline" slot="start"></ion-icon>
    {{ isSavingCandidature ? 'Sauvegarde en cours...' : 'Sauvegarder la Candidature' }}
  </ion-button>

  <!-- Aper√ßus des documents -->
  <div *ngIf="!isGeneratingAIContent && !isSavingCandidature && (atsAnalysisResult || generatedCoverLetter)" class="ion-margin-top results-placeholder">
    <ion-label class="ion-padding-start">Aper√ßu CV Final (√âditable)</ion-label>
    <div class="document-preview-placeholder">CV √âditable</div>
  </div>
  <div *ngIf="!isGeneratingAIContent && !isSavingCandidature && (atsAnalysisResult || generatedCoverLetter)" class="ion-margin-top results-placeholder">
    <ion-label class="ion-padding-start">Aper√ßu Lettre Finale (√âditable)</ion-label>
    <div class="document-preview-placeholder">Lettre √âditable</div>
  </div>
</ion-content>