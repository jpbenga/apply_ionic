<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Postuler</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Postuler</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-item lines="full">
    <ion-label position="stacked">Coller l'offre d'emploi ici</ion-label>
    <ion-textarea
      rows="8"
      placeholder="Entrez ou collez la description complète de l'offre d'emploi..."
      aria-label="Offre d'emploi"
      [(ngModel)]="jobOfferText"
      [disabled]="isExtractingText || isGeneratingAIContent">
    </ion-textarea>
  </ion-item>

  <ion-item lines="full" class="ion-margin-top">
    <ion-label>Votre CV</ion-label>
    <ion-button slot="end" fill="outline" (click)="triggerFileInput()" [disabled]="isExtractingText || isGeneratingAIContent">
      <ion-icon slot="start" name="document-attach-outline"></ion-icon>
      Choisir un CV (DOCX/PDF)
    </ion-button>
    <input type="file" #fileInput hidden
           (change)="handleFileSelected($event)"
           accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.pdf,application/pdf" />
  </ion-item>

  <ion-item *ngIf="selectedFileName && !isExtractingText" lines="none">
    <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
    <ion-label color="medium"><small>{{ selectedFileName }}</small></ion-label>
    <ion-button fill="clear" slot="end" (click)="clearFileSelection()" color="danger" [disabled]="isExtractingText || isGeneratingAIContent">
      <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
    </ion-button>
  </ion-item>

  <ion-item *ngIf="isExtractingText" lines="none">
    <ion-spinner name="crescent" slot="start"></ion-spinner>
    <ion-label>Traitement du CV en cours...</ion-label>
  </ion-item>

  <ion-item *ngIf="!isExtractingText && selectedFile && extractedCvText !== null && (selectedFile.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || selectedFile.name.toLowerCase().endsWith('.docx') || selectedFile.type === 'application/pdf' || selectedFile.name.toLowerCase().endsWith('.pdf'))" lines="none">
    <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
    <ion-label color="success"><small>Texte du CV ({{ getFileTypeLabel(selectedFile) }}) extrait.</small></ion-label>
  </ion-item>

  <ion-item *ngIf="!isExtractingText && selectedFile && extractedCvText === null && (selectedFile.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || selectedFile.name.toLowerCase().endsWith('.docx') || selectedFile.type === 'application/pdf' || selectedFile.name.toLowerCase().endsWith('.pdf')) && selectedFileName" lines="none">
    <ion-icon name="warning" slot="start" color="danger"></ion-icon>
    <ion-label color="danger"><small>Échec de l'extraction du texte du CV ({{ getFileTypeLabel(selectedFile) }}).</small></ion-label>
  </ion-item>

  <div class="ion-margin-top">
    <ion-label class="ion-padding-start">Choisir un template de CV (optionnel)</ion-label>
    <ion-grid>
      <ion-row>
        <ion-col size="4">
          <div class="template-placeholder">Template 1</div>
        </ion-col>
        <ion-col size="4">
          <div class="template-placeholder">Template 2</div>
        </ion-col>
        <ion-col size="4">
          <div class="template-placeholder">Template 3</div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <ion-button expand="block" class="ion-margin-top" (click)="generateApplication()" [disabled]="!jobOfferText || !extractedCvText || isGeneratingAIContent || isExtractingText">
    <ion-spinner *ngIf="isGeneratingAIContent" name="crescent" slot="start"></ion-spinner>
    <ion-icon *ngIf="!isGeneratingAIContent" slot="start" name="sparkles-outline"></ion-icon>
    {{ isGeneratingAIContent ? 'Génération en cours...' : 'Générer CV et Lettre avec l\'IA' }}
  </ion-button>

  <div *ngIf="aiError" class="ion-padding ion-text-center" style="color: var(--ion-color-danger);">
    <p>{{ aiError }}</p>
  </div>

  <div *ngIf="atsAnalysisResult && !isGeneratingAIContent" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Analyse ATS</ion-card-title>
        <p *ngIf="atsAnalysisResult.jobTitle"><strong>Poste :</strong> {{ atsAnalysisResult.jobTitle }}</p>
        <p *ngIf="atsAnalysisResult.company"><strong>Entreprise :</strong> {{ atsAnalysisResult.company }}</p>
      </ion-card-header>
      <ion-card-content>
        <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ atsAnalysisResult.analysisText }}</pre>
      </ion-card-content>
    </ion-card>
  </div>

  <div *ngIf="generatedCoverLetter && !isGeneratingAIContent" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Lettre de Motivation Générée</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ generatedCoverLetter }}</pre>
      </ion-card-content>
    </ion-card>
  </div>
  
  <div *ngIf="!isGeneratingAIContent && (atsAnalysisResult || generatedCoverLetter)" class="ion-margin-top results-placeholder">
    <ion-label class="ion-padding-start">Aperçu CV Final (Éditable)</ion-label>
    <div class="document-preview-placeholder">CV Éditable</div>
  </div>
  <div *ngIf="!isGeneratingAIContent && (atsAnalysisResult || generatedCoverLetter)" class="ion-margin-top results-placeholder">
    <ion-label class="ion-padding-start">Aperçu Lettre Finale (Éditable)</ion-label>
    <div class="document-preview-placeholder">Lettre Éditable</div>
  </div>

</ion-content>