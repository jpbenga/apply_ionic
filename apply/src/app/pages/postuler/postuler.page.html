<ion-header>
  <app-user-header></app-user-header>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Postuler</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Message si pas de donn√©es CV structur√©es -->
  <ion-card *ngIf="!hasStructuredCvData && !isLoadingCvData" color="warning">
    <ion-card-content>
      <div class="text-center">
        <ion-icon name="warning-outline" size="large"></ion-icon>
        <h3>Aucune donn√©e CV structur√©e</h3>
        <p>Pour postuler, vous devez d'abord cr√©er votre CV structur√© avec vos exp√©riences, formations et comp√©tences.</p>
        <ion-button expand="block" (click)="goToMyCv()">
          <ion-icon name="create-outline" slot="start"></ion-icon>
          Cr√©er mon CV structur√©
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Loading CV data -->
  <ion-card *ngIf="isLoadingCvData">
    <ion-card-content class="text-center">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Chargement de vos donn√©es CV...</p>
    </ion-card-content>
  </ion-card>

  <!-- Section principale (visible si donn√©es CV disponibles) -->
  <div *ngIf="hasStructuredCvData && !isLoadingCvData">

    <!-- Section offre d'emploi -->
    <ion-item lines="full">
      <ion-label position="stacked">Coller l'offre d'emploi ici</ion-label>
      <ion-textarea
        rows="8"
        placeholder="Entrez ou collez la description compl√®te de l'offre d'emploi..."
        aria-label="Offre d'emploi"
        [(ngModel)]="jobOfferText"
        [disabled]="isGeneratingAIContent || isSavingCandidature">
      </ion-textarea>
    </ion-item>

    <!-- Bouton g√©n√©rer analyse -->
    <ion-button 
      expand="block" 
      class="ion-margin-top" 
      (click)="generateApplication()" 
      [disabled]="!jobOfferText || isGeneratingAIContent || isSavingCandidature">
      <ion-spinner *ngIf="isGeneratingAIContent" name="crescent" slot="start"></ion-spinner>
      <ion-icon *ngIf="!isGeneratingAIContent" slot="start" name="sparkles-outline"></ion-icon>
      {{ isGeneratingAIContent ? 'G√©n√©ration IA en cours...' : 'Analyser avec l\'IA' }}
    </ion-button>

    <!-- Erreur IA -->
    <div *ngIf="aiError" class="ion-padding ion-text-center" style="color: var(--ion-color-danger);">
      <p>{{ aiError }}</p>
    </div>

    <!-- R√©sultats ATS -->
    <div *ngIf="atsAnalysisResult && !isGeneratingAIContent && !isSavingCandidature" class="ion-margin-top">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Analyse ATS</ion-card-title>
          <p *ngIf="atsAnalysisResult.jobTitle"><strong>Poste :</strong> {{ atsAnalysisResult.jobTitle }}</p>
          <p *ngIf="atsAnalysisResult.company"><strong>Entreprise :</strong> {{ atsAnalysisResult.company }}</p>
        </ion-card-header>
        <ion-card-content>
          <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ atsAnalysisResult.analysisText }}</pre>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Bouton am√©lioration CV -->
    <ion-button 
      expand="block" 
      fill="outline" 
      class="ion-margin-top"
      (click)="improveCv()"
      [disabled]="!atsAnalysisResult || isImprovingCv || isGeneratingAIContent || isSavingCandidature"
      *ngIf="atsAnalysisResult && !structuredCvImprovements">
      <ion-spinner *ngIf="isImprovingCv" name="crescent" slot="start"></ion-spinner>
      <ion-icon *ngIf="!isImprovingCv" slot="start" name="construct-outline"></ion-icon>
      {{ isImprovingCv ? 'Analyse du CV en cours...' : 'Am√©liorer le CV avec l\'IA' }}
    </ion-button>

    <!-- Section des am√©liorations sugg√©r√©es -->
    <div *ngIf="structuredCvImprovements && !isImprovingCv && !improvementsApplied" class="ion-margin-top">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="construct-outline" color="primary"></ion-icon>
            Am√©liorations sugg√©r√©es pour votre CV
            <span class="cv-type-badge structured">CV Structur√©</span>
          </ion-card-title>
          <ion-card-subtitle>
            {{ structuredCvImprovements.summary.totalSuggestions }} suggestion(s) ‚Ä¢ 
            <span *ngIf="structuredCvImprovements.summary.criticalIssues > 0" class="critical-issues">
              {{ structuredCvImprovements.summary.criticalIssues }} critique(s)
            </span>
            <span *ngIf="structuredCvImprovements.summary.enhancementSuggestions > 0">
              {{ structuredCvImprovements.summary.enhancementSuggestions }} am√©lioration(s)
            </span>
            <span *ngIf="structuredCvImprovements.summary.newCompetencesSuggested > 0" class="new-competences">
              + {{ structuredCvImprovements.summary.newCompetencesSuggested }} nouvelle(s) comp√©tence(s)
            </span>
          </ion-card-subtitle>
        </ion-card-header>
        
        <ion-card-content>
          
          <!-- Nouvelles comp√©tences sugg√©r√©es -->
          <div *ngIf="structuredCvImprovements.improvements.suggestedCompetences.length > 0" class="suggested-competences-section">
            <h4>‚ú® Nouvelles comp√©tences sugg√©r√©es</h4>
            <div class="suggested-competences-list">
              <div 
                *ngFor="let competence of structuredCvImprovements.improvements.suggestedCompetences; let i = index" 
                class="suggested-competence-item"
                [class.accepted]="competence.accepted">
                
                <div class="competence-header">
                  <div class="competence-info">
                    <span class="competence-name">{{ competence.nom }}</span>
                    <span class="competence-category">{{ competence.categorie }}</span>
                    <span class="competence-impact" [class]="competence.impact">{{ getImpactLabel(competence.impact) }}</span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="competence.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>
                
                <p class="competence-reason">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ competence.raison }}
                </p>
              </div>
            </div>
          </div>

          <!-- Am√©liorations des exp√©riences -->
          <div *ngIf="structuredCvImprovements.improvements.experiences.length > 0" class="section-improvements">
            <h4>üíº Exp√©riences professionnelles</h4>
            <div 
              *ngFor="let sectionImprovement of structuredCvImprovements.improvements.experiences" 
              class="section-item">
              
              <h5 class="section-title">{{ sectionImprovement.itemTitle }}</h5>
              
              <div 
                *ngFor="let improvement of sectionImprovement.improvements" 
                class="field-improvement"
                [class.accepted]="improvement.accepted"
                [class.critical]="improvement.impact === 'fort'">
                
                <div class="improvement-header">
                  <div class="improvement-meta">
                    <span class="improvement-type" [class]="improvement.type">
                      {{ getImprovementTypeLabel(improvement.type) }}
                    </span>
                    <span class="improvement-field">{{ improvement.field }}</span>
                    <span class="improvement-impact" [class]="improvement.impact">
                      {{ getImpactLabel(improvement.impact) }}
                    </span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="improvement.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>

                <h6>{{ improvement.titre }}</h6>
                
                <div class="field-comparison">
                  <div class="original-value">
                    <label>{{ improvement.field }} actuel :</label>
                    <p>{{ improvement.originalValue }}</p>
                  </div>
                  <div class="improved-value">
                    <label>{{ improvement.field }} am√©lior√© :</label>
                    <p>{{ improvement.improvedValue }}</p>
                  </div>
                </div>
                
                <p class="explanation">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ improvement.explication }}
                </p>
              </div>
            </div>
          </div>

          <!-- Am√©liorations des formations -->
          <div *ngIf="structuredCvImprovements.improvements.formations.length > 0" class="section-improvements">
            <h4>üéì Formations</h4>
            <div 
              *ngFor="let sectionImprovement of structuredCvImprovements.improvements.formations" 
              class="section-item">
              
              <h5 class="section-title">{{ sectionImprovement.itemTitle }}</h5>
              
              <div 
                *ngFor="let improvement of sectionImprovement.improvements" 
                class="field-improvement"
                [class.accepted]="improvement.accepted"
                [class.critical]="improvement.impact === 'fort'">
                
                <div class="improvement-header">
                  <div class="improvement-meta">
                    <span class="improvement-type" [class]="improvement.type">
                      {{ getImprovementTypeLabel(improvement.type) }}
                    </span>
                    <span class="improvement-field">{{ improvement.field }}</span>
                    <span class="improvement-impact" [class]="improvement.impact">
                      {{ getImpactLabel(improvement.impact) }}
                    </span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="improvement.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>

                <h6>{{ improvement.titre }}</h6>
                
                <div class="field-comparison">
                  <div class="original-value">
                    <label>{{ improvement.field }} actuel :</label>
                    <p>{{ improvement.originalValue }}</p>
                  </div>
                  <div class="improved-value">
                    <label>{{ improvement.field }} am√©lior√© :</label>
                    <p>{{ improvement.improvedValue }}</p>
                  </div>
                </div>
                
                <p class="explanation">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ improvement.explication }}
                </p>
              </div>
            </div>
          </div>

          <!-- Am√©liorations des comp√©tences -->
          <div *ngIf="structuredCvImprovements.improvements.competences.length > 0" class="section-improvements">
            <h4>üõ†Ô∏è Comp√©tences</h4>
            <div 
              *ngFor="let sectionImprovement of structuredCvImprovements.improvements.competences" 
              class="section-item">
              
              <h5 class="section-title">{{ sectionImprovement.itemTitle }}</h5>
              
              <div 
                *ngFor="let improvement of sectionImprovement.improvements" 
                class="field-improvement"
                [class.accepted]="improvement.accepted"
                [class.critical]="improvement.impact === 'fort'">
                
                <div class="improvement-header">
                  <div class="improvement-meta">
                    <span class="improvement-type" [class]="improvement.type">
                      {{ getImprovementTypeLabel(improvement.type) }}
                    </span>
                    <span class="improvement-field">{{ improvement.field }}</span>
                    <span class="improvement-impact" [class]="improvement.impact">
                      {{ getImpactLabel(improvement.impact) }}
                    </span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="improvement.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>

                <h6>{{ improvement.titre }}</h6>
                
                <div class="field-comparison">
                  <div class="original-value">
                    <label>{{ improvement.field }} actuel :</label>
                    <p>{{ improvement.originalValue }}</p>
                  </div>
                  <div class="improved-value">
                    <label>{{ improvement.field }} am√©lior√© :</label>
                    <p>{{ improvement.improvedValue }}</p>
                  </div>
                </div>
                
                <p class="explanation">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ improvement.explication }}
                </p>
              </div>
            </div>
          </div>

          <!-- Actions pour les am√©liorations -->
          <div class="improvement-actions ion-margin-top">
            <ion-button 
              fill="clear" 
              (click)="selectAllImprovements(true)"
              [disabled]="isGeneratingAIContent || isSavingCandidature">
              Tout s√©lectionner
            </ion-button>
            <ion-button 
              fill="clear" 
              (click)="selectAllImprovements(false)"
              [disabled]="isGeneratingAIContent || isSavingCandidature">
              Tout d√©s√©lectionner
            </ion-button>
            <ion-button 
              expand="block" 
              color="primary"
              (click)="applySelectedImprovements()"
              [disabled]="!hasAcceptedImprovements() || isGeneratingAIContent || isSavingCandidature">
              <ion-icon slot="start" name="checkmark-outline"></ion-icon>
              Appliquer les modifications ({{ getAcceptedCount() }})
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Comparaison avant/apr√®s avec slider -->
    <div *ngIf="improvedCvData && originalCvData && improvementsApplied" class="cv-comparison-section ion-margin-top">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="git-compare-outline" color="success"></ion-icon>
            Comparaison avant/apr√®s
          </ion-card-title>
          <ion-card-subtitle>Visualisez les am√©liorations de votre CV</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          
          <!-- Contr√¥les de vue -->
          <ion-segment [(ngModel)]="comparisonView" class="ion-margin-bottom">
            <ion-segment-button value="original">
              <ion-label>Original</ion-label>
            </ion-segment-button>
            <ion-segment-button value="split">
              <ion-label>Comparaison</ion-label>
            </ion-segment-button>
            <ion-segment-button value="improved">
              <ion-label>Am√©lior√©</ion-label>
            </ion-segment-button>
          </ion-segment>

          <!-- R√©sum√© des modifications -->
          <div class="modifications-summary ion-margin-bottom">
            <ion-badge color="success">{{ getTotalChangesCount() }} modification(s) appliqu√©e(s)</ion-badge>
            <div class="changes-details">
              <span *ngIf="getChangesCount('experiences') > 0">
                ‚Ä¢ {{ getChangesCount('experiences') }} exp√©rience(s)
              </span>
              <span *ngIf="getChangesCount('formations') > 0">
                ‚Ä¢ {{ getChangesCount('formations') }} formation(s)
              </span>
              <span *ngIf="getChangesCount('competences') > 0">
                ‚Ä¢ {{ getChangesCount('competences') }} comp√©tence(s)
              </span>
            </div>
          </div>

          <!-- Slider de comparaison -->
          <div *ngIf="comparisonView === 'split'" class="comparison-slider-container">
            <div class="cv-comparison-wrapper">
              <div class="cv-original">
                <div class="cv-section-title">CV Original</div>
                <div class="cv-content-display">
                  {{ generateDisplayTextFromCvData(originalCvData) }}
                </div>
              </div>
              <div class="cv-improved" [style.clip-path]="'polygon(' + sliderPosition + '% 0%, 100% 0%, 100% 100%, ' + sliderPosition + '% 100%)'">
                <div class="cv-section-title">CV Am√©lior√©</div>
                <div class="cv-content-display">
                  {{ generateDisplayTextFromCvData(improvedCvData) }}
                </div>
              </div>
              
              <!-- Slider overlay -->
              <div class="slider-overlay" [style.left.%]="sliderPosition">
                <div class="slider-handle">
                  <ion-icon name="resize-outline"></ion-icon>
                </div>
              </div>
            </div>
            
            <ion-range 
              [(ngModel)]="sliderPosition" 
              min="0" 
              max="100" 
              step="1"
              class="comparison-range">
              <ion-label slot="start">Original</ion-label>
              <ion-label slot="end">Am√©lior√©</ion-label>
            </ion-range>
          </div>

          <!-- Vue simple original -->
          <div *ngIf="comparisonView === 'original'" class="single-cv-view">
            <h4>CV Original</h4>
            <div class="cv-content-display">
              {{ generateDisplayTextFromCvData(originalCvData) }}
            </div>
          </div>

          <!-- Vue simple am√©lior√© -->
          <div *ngIf="comparisonView === 'improved'" class="single-cv-view">
            <h4>CV Am√©lior√©</h4>
            <div class="cv-content-display">
              {{ generateDisplayTextFromCvData(improvedCvData) }}
            </div>
          </div>

          <!-- Actions -->
          <div class="comparison-actions ion-margin-top">
            <ion-button 
              expand="block" 
              color="success"
              (click)="saveImprovements()"
              [disabled]="isGeneratingAIContent || isSavingCandidature || isSavingImprovements">
              <ion-spinner *ngIf="isSavingImprovements" name="crescent" slot="start"></ion-spinner>
              <ion-icon *ngIf="!isSavingImprovements" slot="start" name="save-outline"></ion-icon>
              {{ isSavingImprovements ? 'Sauvegarde en cours...' : 'Valider et sauvegarder les am√©liorations' }}
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Section s√©lection template et th√®me (APR√àS validation des am√©liorations) -->
    <div *ngIf="cvImprovementsValidated" class="ion-margin-top">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="brush-outline" color="primary"></ion-icon>
            Personnaliser votre CV
          </ion-card-title>
          <ion-card-subtitle>Choisissez le template et le th√®me pour votre candidature</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          
          <!-- Loading templates -->
          <div *ngIf="isLoadingTemplates" class="text-center ion-padding">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Chargement des templates...</p>
          </div>

          <!-- Grille des templates -->
          <div *ngIf="!isLoadingTemplates" class="template-selection">
            <h4>Template</h4>
            <ion-grid>
              <ion-row>
                <ion-col size="6" size-md="4" size-lg="3" *ngFor="let template of availableTemplates">
                  <div 
                    class="template-card" 
                    [class.selected]="selectedTemplate?.id === template.id"
                    (click)="onTemplateChange(template)">
                    <img [src]="template.imageUrl" [alt]="template.name" />
                    <div class="template-info">
                      <h5>{{ template.name }}</h5>
                      <p><small>{{ template.description }}</small></p>
                    </div>
                    <ion-badge 
                      *ngIf="selectedTemplate?.id === template.id" 
                      color="primary"
                      class="selected-badge">
                      ‚úì
                    </ion-badge>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <!-- S√©lection couleur -->
          <div class="theme-selection ion-margin-top">
            <h4>Couleur principale</h4>
            <div class="color-picker">
              <div 
                *ngFor="let theme of availableThemes"
                class="color-option"
                [class.selected]="selectedTheme.primaryColor === theme.primaryColor"
                [style.background-color]="theme.primaryColor"
                (click)="onThemeChange(theme)">
                <ion-icon 
                  *ngIf="selectedTheme.primaryColor === theme.primaryColor" 
                  name="checkmark" 
                  color="light">
                </ion-icon>
              </div>
            </div>
          </div>

          <!-- Aper√ßu du CV final -->
          <div class="cv-preview-section ion-margin-top" *ngIf="selectedTemplate">
            <h4>Aper√ßu final</h4>
            <div class="cv-preview-container">
              <app-cv-preview 
                [template]="selectedTemplate"
                [theme]="selectedTheme.primaryColor">
              </app-cv-preview>
            </div>
          </div>

          <!-- Bouton g√©n√©rer lettre -->
          <ion-button 
            expand="block" 
            color="secondary"
            class="ion-margin-top"
            (click)="generateCoverLetter()"
            [disabled]="!selectedTemplate || isGeneratingCoverLetter">
            <ion-spinner *ngIf="isGeneratingCoverLetter" name="crescent" slot="start"></ion-spinner>
            <ion-icon *ngIf="!isGeneratingCoverLetter" slot="start" name="document-text-outline"></ion-icon>
            {{ isGeneratingCoverLetter ? 'G√©n√©ration en cours...' : 'G√©n√©rer la lettre de motivation' }}
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Lettre de motivation g√©n√©r√©e (APR√àS personnalisation) -->
    <div *ngIf="generatedCoverLetter && cvImprovementsValidated" class="ion-margin-top">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Lettre de Motivation G√©n√©r√©e</ion-card-title>
          <ion-card-subtitle>Bas√©e sur votre CV am√©lior√©</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ generatedCoverLetter }}</pre>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Bouton sauvegarder candidature (FINAL) -->
    <ion-button 
      *ngIf="generatedCoverLetter && cvImprovementsValidated"
      expand="block" 
      color="success" 
      class="ion-margin-top"
      (click)="saveCandidature()"
      [disabled]="!atsAnalysisResult || !generatedCoverLetter || isSavingCandidature">
      <ion-spinner *ngIf="isSavingCandidature" name="crescent" slot="start"></ion-spinner>
      <ion-icon *ngIf="!isSavingCandidature" name="save-outline" slot="start"></ion-icon>
      {{ isSavingCandidature ? 'Sauvegarde en cours...' : 'Sauvegarder la Candidature' }}
    </ion-button>

  </div>
</ion-content>