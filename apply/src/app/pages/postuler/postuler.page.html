<ion-header>
  <app-user-header></app-user-header>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Postuler</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-item lines="full">
    <ion-label position="stacked">Coller l'offre d'emploi ici</ion-label>
    <ion-textarea
      rows="8"
      placeholder="Entrez ou collez la description compl√®te de l'offre d'emploi..."
      aria-label="Offre d'emploi"
      [(ngModel)]="jobOfferText"
      [disabled]="isExtractingText || isGeneratingAIContent || isSavingCandidature">
    </ion-textarea>
  </ion-item>

  <!-- Section CV -->
  <div class="ion-margin-top cv-selection-section">
    <ion-item lines="none">
      <ion-label>
        <h2>Choisir votre CV</h2>
      </ion-label>
    </ion-item>

    <!-- Spinner pendant le chargement du CV r√©cent -->
    <ion-item *ngIf="isLoadingRecentCv" lines="none">
      <ion-spinner name="crescent" slot="start"></ion-spinner>
      <ion-label>Chargement du CV le plus r√©cent...</ion-label>
    </ion-item>

    <!-- Radio group pour choisir entre CV r√©cent et upload -->
    <ion-radio-group [(ngModel)]="cvSelectionMode" [disabled]="isExtractingText || isGeneratingAIContent || isSavingCandidature">
      
      <!-- Option 1: CV le plus r√©cent -->
      <ion-item *ngIf="mostRecentCv && !isLoadingRecentCv" class="cv-info">
        <ion-radio slot="start" value="recent"></ion-radio>
        <ion-label>
          <h3>Utiliser le CV le plus r√©cent</h3>
          <p>{{ getCvDisplayName() }}</p>
          <p><small>Cr√©√© le {{ getCvCreationDate() }}</small></p>
        </ion-label>
        <ion-icon name="document-text-outline" slot="end" color="primary"></ion-icon>
      </ion-item>

      <!-- Option 2: Upload nouveau CV -->
      <ion-item class="cv-info">
        <ion-radio slot="start" value="upload"></ion-radio>
        <ion-label>
          <h3>Uploader un nouveau CV</h3>
          <p *ngIf="!mostRecentCv && !isLoadingRecentCv"><small>Aucun CV sauvegard√© trouv√©</small></p>
        </ion-label>
        <ion-button 
          slot="end" 
          fill="outline" 
          (click)="triggerFileInput()" 
          [disabled]="cvSelectionMode !== 'upload' || isExtractingText || isGeneratingAIContent || isSavingCandidature">
          <ion-icon slot="start" name="document-attach-outline"></ion-icon>
          Choisir fichier
        </ion-button>
      </ion-item>
    </ion-radio-group>

    <!-- Input file cach√© -->
    <input type="file" #fileInput hidden
           (change)="handleFileSelected($event)"
           accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.pdf,application/pdf" />

    <!-- Affichage du fichier s√©lectionn√© -->
    <ion-item *ngIf="selectedFileName && cvSelectionMode === 'upload' && !isExtractingText" lines="none" class="ion-margin-start">
      <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
      <ion-label color="medium">
        <small>{{ selectedFileName }}</small>
      </ion-label>
      <ion-button fill="clear" slot="end" (click)="clearFileSelection()" color="danger" 
                  [disabled]="isExtractingText || isGeneratingAIContent || isSavingCandidature">
        <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
      </ion-button>
    </ion-item>

    <!-- Extraction en cours -->
    <ion-item *ngIf="isExtractingText" lines="none" class="ion-margin-start">
      <ion-spinner name="crescent" slot="start"></ion-spinner>
      <ion-label>Traitement du CV en cours...</ion-label>
    </ion-item>

    <!-- Succ√®s extraction -->
    <ion-item *ngIf="!isExtractingText && ((cvSelectionMode === 'upload' && selectedFile && extractedCvText !== null) || (cvSelectionMode === 'recent' && mostRecentCv && mostRecentCvText))" 
              lines="none" class="ion-margin-start">
      <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
      <ion-label color="success">
        <small>
          CV pr√™t √† utiliser
          <span *ngIf="cvSelectionMode === 'upload'"> ({{ getFileTypeLabel(selectedFile) }}) extrait</span>
          <span *ngIf="cvSelectionMode === 'recent'"> (CV g√©n√©r√©)</span>
        </small>
      </ion-label>
    </ion-item>

    <!-- √âchec extraction -->
    <ion-item *ngIf="!isExtractingText && cvSelectionMode === 'upload' && selectedFile && extractedCvText === null && selectedFileName" 
              lines="none" class="ion-margin-start">
      <ion-icon name="warning" slot="start" color="danger"></ion-icon>
      <ion-label color="danger">
        <small>√âchec de l'extraction du texte du CV ({{ getFileTypeLabel(selectedFile) }}).</small>
      </ion-label>
    </ion-item>

    <!-- Info pour sauvegarder le CV upload√© -->
    <ion-item *ngIf="cvSelectionMode === 'upload' && extractedCvText && !isExtractingText" lines="none" class="ion-margin-start">
      <ion-label class="ion-margin-start">
        <p><small>üí° Pour sauvegarder un CV, utilisez la section "Mon CV Structur√©"</small></p>
      </ion-label>
    </ion-item>
  </div>

  <!-- Bouton g√©n√©rer -->
  <ion-button expand="block" class="ion-margin-top" (click)="generateApplication()" 
              [disabled]="!jobOfferText || !isCvReady() || isGeneratingAIContent || isExtractingText || isSavingCandidature">
    <ion-spinner *ngIf="isGeneratingAIContent" name="crescent" slot="start"></ion-spinner>
    <ion-icon *ngIf="!isGeneratingAIContent" slot="start" name="sparkles-outline"></ion-icon>
    {{ isGeneratingAIContent ? 'G√©n√©ration IA en cours...' : 'G√©n√©rer Analyse & Lettre' }}
  </ion-button>

  <!-- Erreur IA -->
  <div *ngIf="aiError" class="ion-padding ion-text-center" style="color: var(--ion-color-danger);">
    <p>{{ aiError }}</p>
  </div>

  <!-- R√©sultats ATS -->
  <div *ngIf="atsAnalysisResult && !isGeneratingAIContent && !isSavingCandidature" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Analyse ATS</ion-card-title>
        <p *ngIf="atsAnalysisResult.jobTitle"><strong>Poste :</strong> {{ atsAnalysisResult.jobTitle }}</p>
        <p *ngIf="atsAnalysisResult.company"><strong>Entreprise :</strong> {{ atsAnalysisResult.company }}</p>
      </ion-card-header>
      <ion-card-content>
        <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ atsAnalysisResult.analysisText }}</pre>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Bouton d'am√©lioration CV - apr√®s l'analyse ATS -->
  <ion-button 
    expand="block" 
    fill="outline" 
    class="ion-margin-top"
    (click)="improveCv()"
    [disabled]="!atsAnalysisResult || isImprovingCv || isGeneratingAIContent || isSavingCandidature"
    *ngIf="atsAnalysisResult && !cvImprovements">
    <ion-spinner *ngIf="isImprovingCv" name="crescent" slot="start"></ion-spinner>
    <ion-icon *ngIf="!isImprovingCv" slot="start" name="construct-outline"></ion-icon>
    {{ isImprovingCv ? 'Analyse du CV en cours...' : 'Am√©liorer le CV avec l\'IA' }}
  </ion-button>

  <!-- Section des am√©liorations sugg√©r√©es - Interface adapt√©e -->
  <div *ngIf="(cvImprovements || structuredCvImprovements) && !isImprovingCv" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="construct-outline" color="primary"></ion-icon>
          Am√©liorations sugg√©r√©es pour votre CV
          <span class="cv-type-badge" [class]="getCvImprovementType()">
            {{ getCvImprovementType() === 'structured' ? 'CV Structur√©' : 'CV Upload√©' }}
          </span>
        </ion-card-title>
        <ion-card-subtitle>
          <span *ngIf="structuredCvImprovements">
            {{ structuredCvImprovements.summary.totalSuggestions }} suggestion(s) ‚Ä¢ 
            <span *ngIf="structuredCvImprovements.summary.criticalIssues > 0" class="critical-issues">
              {{ structuredCvImprovements.summary.criticalIssues }} critique(s)
            </span>
            <span *ngIf="structuredCvImprovements.summary.enhancementSuggestions > 0">
              {{ structuredCvImprovements.summary.enhancementSuggestions }} am√©lioration(s)
            </span>
            <span *ngIf="structuredCvImprovements.summary.newCompetencesSuggested > 0" class="new-competences">
              + {{ structuredCvImprovements.summary.newCompetencesSuggested }} nouvelle(s) comp√©tence(s)
            </span>
          </span>
          <span *ngIf="cvImprovements">
            {{ cvImprovements.summary.totalSuggestions }} suggestion(s) ‚Ä¢ 
            <span *ngIf="cvImprovements.summary.criticalIssues > 0" class="critical-issues">
              {{ cvImprovements.summary.criticalIssues }} critique(s)
            </span>
            <span *ngIf="cvImprovements.summary.enhancementSuggestions > 0">
              {{ cvImprovements.summary.enhancementSuggestions }} am√©lioration(s)
            </span>
          </span>
        </ion-card-subtitle>
      </ion-card-header>
      
      <ion-card-content>
        <!-- Interface pour CV Structur√© -->
        <div *ngIf="structuredCvImprovements" class="structured-improvements">
          
          <!-- Nouvelles comp√©tences sugg√©r√©es -->
          <div *ngIf="structuredCvImprovements.improvements.suggestedCompetences.length > 0" class="suggested-competences-section">
            <h4>‚ú® Nouvelles comp√©tences sugg√©r√©es</h4>
            <div class="suggested-competences-list">
              <div 
                *ngFor="let competence of structuredCvImprovements.improvements.suggestedCompetences; let i = index" 
                class="suggested-competence-item"
                [class.accepted]="competence.accepted">
                
                <div class="competence-header">
                  <div class="competence-info">
                    <span class="competence-name">{{ competence.nom }}</span>
                    <span class="competence-category">{{ competence.categorie }}</span>
                    <span class="competence-impact" [class]="competence.impact">{{ getImpactLabel(competence.impact) }}</span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="competence.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>
                
                <p class="competence-reason">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ competence.raison }}
                </p>
              </div>
            </div>
          </div>

          <!-- Am√©liorations des exp√©riences -->
          <div *ngIf="structuredCvImprovements.improvements.experiences.length > 0" class="section-improvements">
            <h4>üíº Exp√©riences professionnelles</h4>
            <div 
              *ngFor="let sectionImprovement of structuredCvImprovements.improvements.experiences" 
              class="section-item">
              
              <h5 class="section-title">{{ sectionImprovement.itemTitle }}</h5>
              
              <div 
                *ngFor="let improvement of sectionImprovement.improvements" 
                class="field-improvement"
                [class.accepted]="improvement.accepted"
                [class.critical]="improvement.impact === 'fort'">
                
                <div class="improvement-header">
                  <div class="improvement-meta">
                    <span class="improvement-type" [class]="improvement.type">
                      {{ getImprovementTypeLabel(improvement.type) }}
                    </span>
                    <span class="improvement-field">{{ improvement.field }}</span>
                    <span class="improvement-impact" [class]="improvement.impact">
                      {{ getImpactLabel(improvement.impact) }}
                    </span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="improvement.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>

                <h6>{{ improvement.titre }}</h6>
                
                <div class="field-comparison">
                  <div class="original-value">
                    <label>{{ improvement.field }} actuel :</label>
                    <p>{{ improvement.originalValue }}</p>
                  </div>
                  <div class="improved-value">
                    <label>{{ improvement.field }} am√©lior√© :</label>
                    <p>{{ improvement.improvedValue }}</p>
                  </div>
                </div>
                
                <p class="explanation">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ improvement.explication }}
                </p>
              </div>
            </div>
          </div>

          <!-- Am√©liorations des formations -->
          <div *ngIf="structuredCvImprovements.improvements.formations.length > 0" class="section-improvements">
            <h4>üéì Formations</h4>
            <div 
              *ngFor="let sectionImprovement of structuredCvImprovements.improvements.formations" 
              class="section-item">
              
              <h5 class="section-title">{{ sectionImprovement.itemTitle }}</h5>
              
              <div 
                *ngFor="let improvement of sectionImprovement.improvements" 
                class="field-improvement"
                [class.accepted]="improvement.accepted"
                [class.critical]="improvement.impact === 'fort'">
                
                <div class="improvement-header">
                  <div class="improvement-meta">
                    <span class="improvement-type" [class]="improvement.type">
                      {{ getImprovementTypeLabel(improvement.type) }}
                    </span>
                    <span class="improvement-field">{{ improvement.field }}</span>
                    <span class="improvement-impact" [class]="improvement.impact">
                      {{ getImpactLabel(improvement.impact) }}
                    </span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="improvement.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>

                <h6>{{ improvement.titre }}</h6>
                
                <div class="field-comparison">
                  <div class="original-value">
                    <label>{{ improvement.field }} actuel :</label>
                    <p>{{ improvement.originalValue }}</p>
                  </div>
                  <div class="improved-value">
                    <label>{{ improvement.field }} am√©lior√© :</label>
                    <p>{{ improvement.improvedValue }}</p>
                  </div>
                </div>
                
                <p class="explanation">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ improvement.explication }}
                </p>
              </div>
            </div>
          </div>

          <!-- Am√©liorations des comp√©tences -->
          <div *ngIf="structuredCvImprovements.improvements.competences.length > 0" class="section-improvements">
            <h4>üõ†Ô∏è Comp√©tences</h4>
            <div 
              *ngFor="let sectionImprovement of structuredCvImprovements.improvements.competences" 
              class="section-item">
              
              <h5 class="section-title">{{ sectionImprovement.itemTitle }}</h5>
              
              <div 
                *ngFor="let improvement of sectionImprovement.improvements" 
                class="field-improvement"
                [class.accepted]="improvement.accepted"
                [class.critical]="improvement.impact === 'fort'">
                
                <div class="improvement-header">
                  <div class="improvement-meta">
                    <span class="improvement-type" [class]="improvement.type">
                      {{ getImprovementTypeLabel(improvement.type) }}
                    </span>
                    <span class="improvement-field">{{ improvement.field }}</span>
                    <span class="improvement-impact" [class]="improvement.impact">
                      {{ getImpactLabel(improvement.impact) }}
                    </span>
                  </div>
                  <ion-checkbox 
                    [(ngModel)]="improvement.accepted"
                    (ionChange)="onImprovementToggle()"
                    [disabled]="isGeneratingAIContent || isSavingCandidature">
                  </ion-checkbox>
                </div>

                <h6>{{ improvement.titre }}</h6>
                
                <div class="field-comparison">
                  <div class="original-value">
                    <label>{{ improvement.field }} actuel :</label>
                    <p>{{ improvement.originalValue }}</p>
                  </div>
                  <div class="improved-value">
                    <label>{{ improvement.field }} am√©lior√© :</label>
                    <p>{{ improvement.improvedValue }}</p>
                  </div>
                </div>
                
                <p class="explanation">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  {{ improvement.explication }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Interface pour CV Upload√© (existante) -->
        <div *ngIf="cvImprovements" class="text-improvements">
          <!-- Mots-cl√©s ATS manquants -->
          <div *ngIf="cvImprovements.summary.atsKeywords.length > 0" class="ats-keywords-section">
            <h4>üéØ Mots-cl√©s ATS manquants</h4>
            <div class="keywords-chips">
              <ion-chip *ngFor="let keyword of cvImprovements.summary.atsKeywords" color="warning">
                <ion-label>{{ keyword }}</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Liste des am√©liorations texte -->
          <div class="improvements-list">
            <div 
              *ngFor="let improvement of cvImprovements.improvements; let i = index" 
              class="improvement-item"
              [class.accepted]="improvement.accepted"
              [class.critical]="improvement.impact === 'fort'">
              
              <div class="improvement-header">
                <div class="improvement-meta">
                  <span class="improvement-type" [class]="improvement.type">
                    {{ getImprovementTypeLabel(improvement.type) }}
                  </span>
                  <span class="improvement-section">{{ improvement.section }}</span>
                  <span class="improvement-impact" [class]="improvement.impact">
                    {{ getImpactLabel(improvement.impact) }}
                  </span>
                </div>
                <ion-checkbox 
                  [(ngModel)]="improvement.accepted"
                  (ionChange)="onImprovementToggle()"
                  [disabled]="isGeneratingAIContent || isSavingCandidature">
                </ion-checkbox>
              </div>

              <h5>{{ improvement.titre }}</h5>
              
              <div class="text-comparison">
                <div class="original-text">
                  <label>Texte actuel :</label>
                  <p>{{ improvement.textOriginal }}</p>
                </div>
                <div class="improved-text">
                  <label>Suggestion :</label>
                  <p>{{ improvement.textAmeliore }}</p>
                </div>
              </div>
              
              <p class="explanation">
                <ion-icon name="information-circle-outline"></ion-icon>
                {{ improvement.explication }}
              </p>
            </div>
          </div>
        </div>

        <!-- Actions communes -->
        <div class="improvement-actions ion-margin-top">
          <ion-button 
            fill="clear" 
            (click)="selectAllImprovements(true)"
            [disabled]="isGeneratingAIContent || isSavingCandidature">
            Tout s√©lectionner
          </ion-button>
          <ion-button 
            fill="clear" 
            (click)="selectAllImprovements(false)"
            [disabled]="isGeneratingAIContent || isSavingCandidature">
            Tout d√©s√©lectionner
          </ion-button>
          <ion-button 
            expand="block" 
            color="primary"
            (click)="applySelectedImprovements()"
            [disabled]="!hasAcceptedImprovements() || isGeneratingAIContent || isSavingCandidature">
            <ion-icon slot="start" name="checkmark-outline"></ion-icon>
            Appliquer les modifications ({{ getAcceptedCount() }})
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Message CV am√©lior√© - Version adapt√©e -->
  <ion-card *ngIf="improvedCvText || improvedStructuredCvData" color="success" class="ion-margin-top">
    <ion-card-content>
      <ion-icon name="checkmark-circle" color="light"></ion-icon>
      <strong>CV am√©lior√© !</strong> 
      <span *ngIf="improvedCvText">
        {{ appliedImprovementsCount }} modification(s) appliqu√©e(s).
      </span>
      <span *ngIf="improvedStructuredCvData">
        {{ appliedStructuredImprovementsCount }} modification(s) appliqu√©e(s) sur vos donn√©es.
      </span>
      Le CV am√©lior√© sera utilis√© pour g√©n√©rer la lettre de motivation.
    </ion-card-content>
  </ion-card>

  <!-- Lettre de motivation -->
  <div *ngIf="generatedCoverLetter && !isGeneratingAIContent && !isSavingCandidature" class="ion-margin-top">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Lettre de Motivation G√©n√©r√©e</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ generatedCoverLetter }}</pre>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Bouton sauvegarder candidature -->
  <ion-button expand="block" color="success" class="ion-margin-top"
              (click)="saveCandidature()"
              [disabled]="!atsAnalysisResult || !generatedCoverLetter || isSavingCandidature || isGeneratingAIContent || isExtractingText">
    <ion-spinner *ngIf="isSavingCandidature" name="crescent" slot="start"></ion-spinner>
    <ion-icon *ngIf="!isSavingCandidature" name="save-outline" slot="start"></ion-icon>
    {{ isSavingCandidature ? 'Sauvegarde en cours...' : 'Sauvegarder la Candidature' }}
  </ion-button>

  <!-- Aper√ßus des documents -->
  <div *ngIf="!isGeneratingAIContent && !isSavingCandidature && (atsAnalysisResult || generatedCoverLetter)" class="ion-margin-top results-placeholder">
    <ion-label class="ion-padding-start">Aper√ßu CV Final (√âditable)</ion-label>
    <div class="document-preview-placeholder">CV √âditable</div>
  </div>
  <div *ngIf="!isGeneratingAIContent && !isSavingCandidature && (atsAnalysisResult || generatedCoverLetter)" class="ion-margin-top results-placeholder">
    <ion-label class="ion-padding-start">Aper√ßu Lettre Finale (√âditable)</ion-label>
    <div class="document-preview-placeholder">Lettre √âditable</div>
  </div>
</ion-content>